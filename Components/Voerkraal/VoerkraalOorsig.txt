
import React, { useState } from "react";
import { Card, CardHeader, CardTitle, CardContent } from "@/components/ui/card";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Wheat, Edit, History } from "lucide-react";
import { ActionHistory } from "@/entities/all";

export default function VoerkralOorsig({ voerkrals, plase, onEdit }) {
  const [history, setHistory] = useState([]);
  const [loadingHistory, setLoadingHistory] = useState(false);
  const [selectedKraalId, setSelectedKraalId] = useState(null);

  const getPlaasNaam = (plaasId) => {
    return plase.find(p => p.id === plaasId)?.naam || 'Onbekend';
  };
  
  const fetchHistory = async (kraalId) => {
      if (selectedKraalId === kraalId) {
          setSelectedKraalId(null);
          return;
      }
      setSelectedKraalId(kraalId);
      setLoadingHistory(true);
      const historyData = await ActionHistory.filter({ entity_id: kraalId, entity_type: 'Voerkral' }, "-created_date");
      setHistory(historyData);
      setLoadingHistory(false);
  };

  return (
    <Card className="shadow-lg bg-white/80 backdrop-blur-sm">
      <CardHeader className="p-6 border-b border-stone-100">
        <CardTitle className="flex items-center gap-2 text-xl font-bold text-stone-800">
          <Wheat className="w-5 h-5 text-orange-500" />
          My Voerkrale
        </CardTitle>
      </CardHeader>
      <CardContent className="p-0">
        {voerkrals.length > 0 ? (
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow className="bg-stone-50">
                  <TableHead>Naam</TableHead>
                  <TableHead>Plaas</TableHead>
                  <TableHead>Status</TableHead>
                  <TableHead>Skape</TableHead>
                  <TableHead>Aksies</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {voerkrals.map((kraal) => (
                  <React.Fragment key={kraal.id}>
                    <TableRow className="hover:bg-stone-50 transition-colors">
                      <TableCell className="font-bold">{kraal.naam}</TableCell>
                      <TableCell>{getPlaasNaam(kraal.plaas_id)}</TableCell>
                      <TableCell>
                        <Badge variant={kraal.aktief ? "default" : "secondary"} className={kraal.aktief ? "bg-green-500" : ""}>
                          {kraal.aktief ? "Aktief" : "Onaktief"}
                        </Badge>
                      </TableCell>
                      <TableCell>
                        {Object.values(kraal.skaap_getalle || {}).reduce((sum, val) => sum + val, 0)}
                      </TableCell>
                      <TableCell>
                        <div className="flex gap-2">
                          <Button size="sm" variant="ghost" onClick={() => onEdit(kraal)} className="h-8 w-8 p-0 hover:bg-blue-100">
                            <Edit className="w-4 h-4 text-blue-600" />
                          </Button>
                          <Button size="sm" variant="ghost" onClick={() => fetchHistory(kraal.id)} className="h-8 w-8 p-0 hover:bg-green-100">
                            <History className="w-4 h-4 text-green-600" />
                          </Button>
                        </div>
                      </TableCell>
                    </TableRow>
                    {selectedKraalId === kraal.id && (
                        <TableRow>
                            <TableCell colSpan={5} className="p-4 bg-stone-50">
                                {loadingHistory ? <p>Laai geskiedenis...</p> : (
                                    history.length > 0 ? (
                                        <div className="max-h-60 overflow-y-auto">
                                            <h4 className="font-semibold mb-2">Geskiedenis vir {kraal.naam}</h4>
                                            <ul className="space-y-2">
                                                {history.map(entry => (
                                                    <li key={entry.id} className="text-xs p-2 bg-white rounded">
                                                        <p><strong>Aksie:</strong> {entry.beskrywing}</p>
                                                        <p><strong>Datum:</strong> {new Date(entry.created_date).toLocaleString('af-ZA')}</p>
                                                    </li>
                                                ))}
                                            </ul>
                                        </div>
                                    ) : <p>Geen geskiedenis gevind nie.</p>
                                )}
                            </TableCell>
                        </TableRow>
                    )}
                  </React.Fragment>
                ))}
              </TableBody>
            </Table>
          </div>
        ) : (
          <div className="text-center py-12 text-stone-500">
            <Wheat className="w-12 h-12 mx-auto mb-4 opacity-50" />
            <p>Geen voerkrale nog nie</p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
